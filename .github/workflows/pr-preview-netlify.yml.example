# Alternative: PR Preview with Netlify
# To use this instead of Cloudflare:
# 1. Rename this file to pr-preview-netlify.yml
# 2. Delete or disable pr-preview-deploy.yml
# 3. Add NETLIFY_AUTH_TOKEN and NETLIFY_SITE_ID to GitHub secrets
# 4. Remove the .example extension

name: PR Preview Deploy (Netlify)

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]

permissions:
  pull-requests: write
  deployments: write
  contents: read

jobs:
  check-contributor:
    name: Verify Contributor
    runs-on: ubuntu-latest
    outputs:
      is-contributor: ${{ steps.check.outputs.is-contributor }}
    steps:
      - name: Check if user is contributor
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            if (context.payload.pull_request.head.repo.full_name !== context.payload.pull_request.base.repo.full_name) {
              console.log('PR from fork - skipping preview');
              core.setOutput('is-contributor', 'false');
              return;
            }

            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: context.payload.pull_request.user.login
              });

              const hasAccess = ['write', 'admin', 'maintain'].includes(permission.permission);
              core.setOutput('is-contributor', hasAccess.toString());
            } catch (error) {
              core.setOutput('is-contributor', 'false');
            }

  deploy-preview:
    name: Deploy Preview
    needs: check-contributor
    if: needs.check-contributor.outputs.is-contributor == 'true' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build
        env:
          NODE_ENV: production

      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: './dist'
          production-deploy: false
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: 'Deploy from PR #${{ github.event.pull_request.number }}'
          alias: pr-${{ github.event.pull_request.number }}
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
