---
import BaseLayout from './BaseLayout.astro';

interface Props {
  title: string;
  excerpt?: string;
  date: Date;
  reading_time?: string;
  categories?: string[];
  tags?: string[];
  hero_image?: string;
}

const { title, excerpt, date, reading_time, categories = [], tags = [], hero_image } = Astro.props;

const formattedDate = new Intl.DateTimeFormat('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
}).format(date);
---

<BaseLayout
  title={title}
  description={excerpt}
  image={hero_image}
  article={true}
  publishedTime={date}
  tags={tags}
  categories={categories}
>
  <article class="container py-8 md:py-12 lg:py-16">
    <div class="mx-auto max-w-3xl">
      <div class="space-y-4">
        <div class="flex flex-wrap gap-2">
          {categories.map((category) => (
            <a
              href={`/categories/${category}`}
              class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80"
            >
              {category}
            </a>
          ))}
        </div>
        <h1 class="scroll-m-20 text-3xl font-extrabold tracking-tight md:text-4xl">
          {title}
        </h1>
        {excerpt && (
          <p class="text-xl text-muted-foreground">
            {excerpt}
          </p>
        )}
        <div class="flex items-center gap-4 text-sm text-muted-foreground">
          <time datetime={date.toISOString()}>{formattedDate}</time>
          {reading_time && (
            <>
              <span>â€¢</span>
              <span>{reading_time}</span>
            </>
          )}
        </div>
      </div>
      {hero_image && (
        <div class="my-8">
          <img
            src={hero_image}
            alt={title}
            class="w-full rounded-lg border border-border"
            loading="eager"
          />
        </div>
      )}
      <hr class="my-8" />
      <div class="prose prose-lg dark:prose-invert max-w-none prose-img:max-h-[400px] prose-img:w-auto prose-img:mx-auto prose-img:cursor-zoom-in prose-img:rounded-lg prose-img:border prose-img:border-border">
        <slot />
      </div>

      <!-- Lightbox modal -->
      <dialog id="image-lightbox" class="fixed inset-0 z-50 m-0 h-screen w-screen max-h-none max-w-none bg-transparent p-0 backdrop:bg-black/80">
        <div class="flex h-full w-full items-center justify-center p-4" id="lightbox-backdrop">
          <div class="relative max-h-[90vh] max-w-[90vw]">
            <img id="lightbox-img" src="" alt="" class="max-h-[90vh] max-w-[90vw] rounded-lg object-contain" />
            <p id="lightbox-caption" class="mt-2 text-center text-sm text-white/80"></p>
          </div>
        </div>
      </dialog>
      {tags.length > 0 && (
        <div class="mt-8 pt-8 border-t">
          <div class="flex flex-wrap gap-2">
            <span class="text-sm font-medium">Tags:</span>
            {tags.map((tag) => (
              <a
                href={`/tags/${tag}`}
                class="inline-flex items-center rounded-md border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 text-foreground hover:bg-accent hover:text-accent-foreground"
              >
                {tag}
              </a>
            ))}
          </div>
        </div>
      )}
    </div>
  </article>

  <script>
    const dialog = document.getElementById('image-lightbox') as HTMLDialogElement;
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
    const lightboxCaption = document.getElementById('lightbox-caption') as HTMLParagraphElement;
    const backdrop = document.getElementById('lightbox-backdrop') as HTMLDivElement;

    // Attach click handler to all images in the prose area and BlogImage figures
    document.querySelectorAll('.prose img, .blog-image img').forEach((img) => {
      const imgEl = img as HTMLImageElement;
      imgEl.addEventListener('click', () => {
        lightboxImg.src = imgEl.src;
        lightboxImg.alt = imgEl.alt;

        // Check for caption from figcaption sibling
        const figure = imgEl.closest('figure');
        const caption = figure?.querySelector('figcaption')?.textContent || '';
        lightboxCaption.textContent = caption;
        lightboxCaption.style.display = caption ? '' : 'none';

        dialog.showModal();
      });
    });

    // Close on backdrop click
    backdrop.addEventListener('click', (e) => {
      if (e.target === backdrop) {
        dialog.close();
      }
    });

    // Close on Escape (native dialog behavior) and image click
    lightboxImg.addEventListener('click', () => dialog.close());
  </script>
</BaseLayout>
