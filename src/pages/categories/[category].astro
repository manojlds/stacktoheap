---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Card from '@/components/Card.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => !data.draft);
  const uniqueCategories = [...new Set(allPosts.flatMap((post) => post.data.categories))];

  return uniqueCategories.map((category) => {
    const filteredPosts = allPosts
      .filter((post) => post.data.categories.includes(category))
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

    return {
      params: { category },
      props: { posts: filteredPosts, category },
    };
  });
}

const { posts, category } = Astro.props;
---

<BaseLayout title={`Category: ${category}`}>
  <div class="container py-8 md:py-12 lg:py-16">
    <div class="flex flex-col gap-4 mb-10">
      <div class="flex items-center gap-2">
        <a href={'/categories'} class="text-muted-foreground hover:text-foreground">Categories</a>
        <span class="text-muted-foreground">/</span>
        <h1 class="text-4xl font-extrabold tracking-tight">{category}</h1>
      </div>
      <p class="text-xl text-muted-foreground">
        {posts.length} {posts.length === 1 ? 'post' : 'posts'} in category "{category}".
      </p>
    </div>

    <div class="grid gap-6">
      {posts.map((post) => {
        const { title, excerpt, date, categories, reading_time } = post.data;
        const formattedDate = new Intl.DateTimeFormat('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        }).format(date);

        // Generate the Jekyll-compatible URL
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const slug = post.slug;
        const url = `/blog/${year}/${month}/${day}/${slug}`;

        return (
          <Card class="p-6 transition-all hover:shadow-lg">
            <div class="flex flex-col gap-3">
              {categories && categories.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {categories.map((cat) => (
                    <a
                      href={`/categories/${cat}`}
                      class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80"
                    >
                      {cat}
                    </a>
                  ))}
                </div>
              )}
              <a href={url} class="group">
                <h3 class="text-2xl font-bold tracking-tight group-hover:underline">
                  {title}
                </h3>
              </a>
              {excerpt && (
                <p class="text-muted-foreground line-clamp-2">
                  {excerpt}
                </p>
              )}
              <div class="flex items-center gap-3 text-sm text-muted-foreground">
                <time datetime={date.toISOString()}>{formattedDate}</time>
                {reading_time && (
                  <>
                    <span>â€¢</span>
                    <span>{reading_time}</span>
                  </>
                )}
              </div>
            </div>
          </Card>
        );
      })}
    </div>
  </div>
</BaseLayout>
