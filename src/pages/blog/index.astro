---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Card from '@/components/Card.astro';
import { getCollection } from 'astro:content';

const base = import.meta.env.BASE_URL;

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const sortedPosts = allPosts.sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf()
);

// Group posts by year
const postsByYear = sortedPosts.reduce((acc, post) => {
  const year = post.data.date.getFullYear();
  if (!acc[year]) {
    acc[year] = [];
  }
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof sortedPosts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="Blog">
  <div class="container py-8 md:py-12 lg:py-16">
    <div class="flex flex-col gap-4 mb-10">
      <h1 class="text-4xl font-extrabold tracking-tight lg:text-5xl">Blog</h1>
      <p class="text-xl text-muted-foreground">
        {sortedPosts.length} posts about software development, DevOps, and technology.
      </p>
    </div>

    <div class="space-y-12">
      {years.map((year) => (
        <div>
          <h2 class="text-2xl font-bold mb-6 pb-2 border-b">{year}</h2>
          <div class="grid gap-6">
            {postsByYear[Number(year)].map((post) => {
              const { title, excerpt, date, categories, reading_time } = post.data;
              const formattedDate = new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              }).format(date);

              // Generate the Jekyll-compatible URL
              const year = date.getFullYear();
              const month = String(date.getMonth() + 1).padStart(2, '0');
              const day = String(date.getDate()).padStart(2, '0');
              const slug = post.slug;
              const url = `${base}/blog/${year}/${month}/${day}/${slug}`;

              return (
                <Card class="p-6 transition-all hover:shadow-lg">
                  <div class="flex flex-col gap-3">
                    {categories && categories.length > 0 && (
                      <div class="flex flex-wrap gap-2">
                        {categories.map((category) => (
                          <a
                            href={`${base}/categories/${category}`}
                            class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80"
                          >
                            {category}
                          </a>
                        ))}
                      </div>
                    )}
                    <a href={url} class="group">
                      <h3 class="text-2xl font-bold tracking-tight group-hover:underline">
                        {title}
                      </h3>
                    </a>
                    {excerpt && (
                      <p class="text-muted-foreground line-clamp-2">
                        {excerpt}
                      </p>
                    )}
                    <div class="flex items-center gap-3 text-sm text-muted-foreground">
                      <time datetime={date.toISOString()}>{formattedDate}</time>
                      {reading_time && (
                        <>
                          <span>â€¢</span>
                          <span>{reading_time}</span>
                        </>
                      )}
                    </div>
                  </div>
                </Card>
              );
            })}
          </div>
        </div>
      ))}
    </div>
  </div>
</BaseLayout>
